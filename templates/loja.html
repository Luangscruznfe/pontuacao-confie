if request.method == 'POST':
    data = request.form.get('data')
    criterios = request.form.getlist('criterios')
    observacao = request.form.get('observacao', '')
    extras = request.form.getlist('extras')

    pesos = {'A': 1, 'B': 1, 'C': 1, 'D': -1, 'E': -2}

    A = int('A' in criterios)
    B = int('B' in criterios)
    C = int('C' in criterios)
    D = int('D' in criterios)
    E = int('E' in criterios)

    # Pontos extras
    extras_pontos = 0
    if 'meta' in extras:
        extras_pontos += 2
    if 'equipe90' in extras:
        extras_pontos += 1

    total = sum([pesos[c] for c in criterios]) + extras_pontos

    conn = get_db_connection()
    c = conn.cursor()
    c.execute("INSERT INTO loja (data, A, B, C, D, E, extras, observacao, total) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)",
              (data, A, B, C, D, E, ','.join(extras), observacao, total))
    conn.commit()
    conn.close()
    flash("✅ Pontuação registrada com sucesso!", "success")
    fazer_backup_e_enviar()
    return redirect('/loja')
