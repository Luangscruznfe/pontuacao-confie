{% extends 'base.html' %}

{% block title %}Hist√≥rico - Log√≠stica{% endblock %}

{% block content %}
<style>
  .setor-financeiro { color: #e74c3c; font-weight: bold; }
  .setor-faturamento { color: #2ecc71; font-weight: bold; }
  .setor-rh { color: #6c5ce7; font-weight: bold; }
  .setor-gerente { color: #b58900; font-weight: bold; }
</style>

<div class="container">
  <h2 class="mb-4">üöõ Hist√≥rico de Pontua√ß√£o - Log√≠stica</h2>

  <!-- FILTRO POR MOTORISTA -->
  <form method="get" class="mb-3">
    <label for="motorista">Filtrar por motorista:</label>
    <select name="motorista" id="motorista" class="form-select" onchange="this.form.submit()">
      <option value="">Todos</option>
      {% for m in motoristas %}
        <option value="{{ m }}" {% if m == motorista %}selected{% endif %}>{{ m }}</option>
      {% endfor %}
    </select>
  </form>

  <div class="table-responsive">
    <table class="table table-bordered text-white">
      <thead class="table-dark">
        <tr>
          <th>Data</th>
          <th>Motorista</th>
          <th>
            Entregas conclu√≠das 100%<br>
            <span class="setor-financeiro">(Financeiro)</span>
          </th>
          <th>
            Ve√≠culo limpo e organizado<br>
            <span class="setor-gerente">(Gerente ADM)</span>
          </th>
          <th>
            Acerto organizado e correto<br>
            <span class="setor-financeiro">(Financeiro)</span>
          </th>
          <th>
            Quest√µes em rela√ß√£o √† jornada<br>
            <span class="setor-rh">(RH)</span>
          </th>
          <th>
            Erro do entregador<br>
            <span class="setor-faturamento">(Faturamento)</span>
          </th>
          <th>Extras</th>
          <th>Observa√ß√£o</th>
          <th>Total</th>
        </tr>
      </thead>

      <tbody>
        {% set ns = namespace(total_geral=0) %}
        {% for r in registros %}
          {% set extras = r[7].split(',') if r[7] else [] %}
          {% set total_parcial = (r[2]|int) + (r[3]|int) + (r[4]|int) + (r[5]|int) + (r[6]|int) %}
          {% if 'meta' in extras %} {% set total_parcial = total_parcial + 2 %} {% endif %}
          {% if 'equipe90' in extras %} {% set total_parcial = total_parcial + 1 %} {% endif %}
          {% if 'economia' in extras %} {% set total_parcial = total_parcial + 2 %} {% endif %}
          {% set ns.total_geral = ns.total_geral + total_parcial %}
          <tr>
            <td>{{ r[0]|datetimeformat }}</td>
            <td>{{ r[1] }}</td>
            <td>{{ r[2] }}</td>
            <td>{{ r[3] }}</td>
            <td>{{ r[4] }}</td>
            <td>{{ r[5] }}</td>
            <td>{{ r[6] }}</td>
            <td>
              {% for extra in extras %}
                {% if extra == 'meta' %}
                  ‚≠ê Meta di√°ria batida / Convers√£o 70%<br>
                {% elif extra == 'equipe90' %}
                  ü§ù Equipe chegou a 90% da meta geral<br>
                {% elif extra == 'economia' %}
                  ‚õΩ Economia de combust√≠vel 10% geral<br>
                {% endif %}
              {% endfor %}
            </td>
            <td>{{ r[8] if r[8] and r[8]|string|lower != 'nan' else '' }}</td>
            <td>{{ total_parcial }}</td>
          </tr>
        {% endfor %}
      </tbody>

      <tfoot class="table-dark">
        <tr>
          <td colspan="9" class="text-end fw-bold">Total Geral:</td>
          <td class="fw-bold {% if ns.total_geral >= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ ns.total_geral }}
          </td>
        </tr>
        <tr>
          <td colspan="9" class="text-end fw-bold">M√©dia:</td>
          <td class="fw-bold text-info">{{ media }}</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <a href="/" class="btn btn-secondary mt-3">üîô Voltar</a>
</div>
{% endblock %}
